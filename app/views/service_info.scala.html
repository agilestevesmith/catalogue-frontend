@*
* Copyright 2016 HM Revenue & Customs
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*     http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*@

@import uk.gov.hmrc.cataloguefrontend.RepositoryDetails
@import uk.gov.hmrc.cataloguefrontend.ViewMessages
@import uk.gov.hmrc.cataloguefrontend.ViewMessages._
@import play.twirl.api.Html
@import uk.gov.hmrc.cataloguefrontend.DeploymentThroughputDataPoint

@import uk.gov.hmrc.cataloguefrontend.ChartData
@(cacheTimestampFormatted: String, service: RepositoryDetails, throughputChartData: Option[ChartData], stabilityChartData: Option[ChartData])

@standard_layout(service.name,"services") {
<header>
    <h1>Service: @service.name</h1>
    <time class="last-updated">Last updated at: @cacheTimestampFormatted</time>

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</header>

<div class="alert alert-success" role="alert" id="@service.name">
    <p>
        @Html(ViewMessages.informationalText)
    </p>
</div>
<section class="section-wrapper">
    <div class="row">
        @partials.repo_owning_teams(service)
        @partials.code_and_builds(service)
    </div>
    <div class="row">
        @for(environment <- service.environments.get){
        <div class="col-md-3">
            <div class="board">
                <h3 class="board__heading">@environment.name</h3>
                <div class="board__body">
                    <ul class="list list--minimal">
                        @for(tool <- environment.services){
                            <li class="list-item"><a href="@{tool.url}" target="_blank">@{tool.displayName}</a></li>
                        }
                    </ul>
                </div>
            </div>
        </div>
        }
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="board">
                <h3 class="board__heading">Indicators</h3>
                <div class="board__body">
                    <h4 class="indicator__title">Frequent Production Releases</h4>
                    @if(throughputChartData.isDefined && !throughputChartData.get.isEmpty) {
                        @Html(ViewMessages.fprExplanationText)
                    }
                    <div id="chart_div">
                    @if(throughputChartData.isEmpty) {
                        <h2 class="chart-message text-center">The catalogue encountered an error</h2>
                        <p>@Html(ViewMessages.indicatorsServiceError)</p>
                    } else {
                        @if(throughputChartData.get.isEmpty) {
                            <h2 class="chart-message text-center">No data to show</h2>
                            <p>@Html(ViewMessages.noIndicatorsData)</p>
                        }
                    }
                    </div>
                    <div id="chart_div_2">

                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
}

<script type="text/javascript">


    @if(throughputChartData.isDefined && !throughputChartData.get.isEmpty) {
        google.charts.load('current', {packages: ['corechart', 'line']});
        google.charts.setOnLoadCallback(function () {
            var options = {
                title: 'Deployment throughput indicator',
                height: 350,
                hAxis: {title: 'Period', textStyle : {fontSize : 10}},
                vAxis: {title: 'Days', textStyle : {fontSize : 10}},
                lineWidth: 3,
                pointSize: 4,
                legend: {textStyle : {fontSize : 10}, position : 'top'},
                tooltip: { isHtml: true, trigger: 'selection' }
            };

            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Period');
            data.addColumn('number', 'Lead time');
            data.addColumn({'type': 'string', 'role': 'tooltip', 'p': {'html': true}});
            data.addColumn('number', 'Interval');
            data.addColumn({'type': 'string', 'role': 'tooltip', 'p': {'html': true}});

            @throughputChartData.get.rows.map{row =>
                data.addRow(@row);
            }

            var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
            chart.draw(data, options);

        });
    }

    @if(stabilityChartData.isDefined && !stabilityChartData.get.isEmpty) {
        google.charts.load('current', {packages: ['corechart', 'line']});
        google.charts.setOnLoadCallback(function () {

            var classicOptions = {
            title: 'Deployment Stability indicator',
            height: 350,
            // Gives each series an axis that matches the vAxes number below.
            series: {
              0: {targetAxisIndex: 0},
              1: {targetAxisIndex: 1}
            },
            vAxes: {
              // Adds titles to each axis.
              0: {title: 'Hotfix Deployments', format:"#%", viewWindow:{
                                  max:1,
                                  min:0
                                  }},
              1: {title: 'Days'}
            },
            lineWidth: 3,
            pointSize : 4,
            legend: {textStyle : {fontSize : 10}},
            hAxis: {title: 'Period', textStyle : {fontSize : 10}},
            vAxis: { textStyle : {fontSize : 10}},
            colors: ["orange", "green"]
          };


            var data = new google.visualization.DataTable();
             data.addColumn('string', 'Period');
             data.addColumn('number', "Hotfix rate");
             data.addColumn('number', "Hotfix lead time");
              @stabilityChartData.get.rows.map{row =>
                    data.addRow(@row);
                }
    //         data.addRows([
    //                ["2014-0", 0.7,  -.5],
    //                ["2014-1", 0.7,   .4],
    //                ["2014-2",0.12,   .5],
    //                ["2014-3", 0.3,  2.9],
    //                ["2014-4", 0.6,  6.3],
    //                ["2014-5", 0.2,    90],
    //                ["2014-6", 0.8, 10.6],
    //                ["2014-7", 0.6, 10.3],
    //                ["2014-8", 0.3,  7.4],
    //                ["2014-9", 0.9,  4.4],
    //                ["2014-1", 0.6, 1.1 ],
    //                ["2014-1", 0.5, -.2 ]
    //              ]);


            var chart = new google.visualization.LineChart(document.getElementById('chart_div_2'));
            chart.draw(data, classicOptions);

            });
       }





</script>